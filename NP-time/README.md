# NP-Time

弹窗预约、小费、多语言兼容、下单后自动为用户注册激活发送邮件的WordPress插件。

开发者：NopassDev（https://nopassdev.com/）

## 功能特性

### 配送设置
- 支持本地和非本地邮编配送规则
- 可按星期几设置配送时间
- 弹窗式配送信息选择界面
- 购物车和结账页配送信息展示

### 小费功能
- 结账页可配置小费金额按钮
- 支持预设金额和自定义金额
- 可选择"残忍拒绝"小费

### 用户注册功能 （新增）
- **自动注册**：下单后自动为未注册邮箱创建账户
- **激活邮件**：向新用户发送账户激活邮件
- **自定义设置密码链接**：支持自定义密码设置页面URL，默认使用WooCommerce我的账户页面
- **可配置邮件内容**：自定义邮件主题和内容模板
- **多语言支持**：完整支持GTranslate、WPML、TranslatePress等多语言插件

### 优惠券系统
- 用户可查看和使用可用优惠券
- 支持优惠券弹窗选择

## 结构
- `np-time.php`: 插件入口，定义常量并初始化
- `includes/class-np-time.php`: 主类，包含前端功能和WooCommerce集成
- `includes/Admin/class-np-time-admin.php`: 后台管理界面
- `assets/`: 静态资源（CSS、JS）
- `data/`: 数据存储目录（邮编配置等）
- `languages/`: 语言包目录

## 用户注册设置使用说明

### 后台配置
1. 进入 WordPress 后台
2. 导航至 "NP-Time" -> "用户注册设置"
3. 配置以下选项：

#### 自动注册功能
- 启用/禁用下单后自动为未注册邮箱创建账户

#### 自定义设置密码链接
- **默认行为**：自动使用WooCommerce我的账户页面的密码重置链接
- **自定义URL**：可填写完全自定义的链接，例如 `https://yourdomain.com/set-password?key=%key%&login=%login%`
- 支持的占位符：
  - `%key%` - 密码重置密钥
  - `%login%` - 用户名  
  - `%email%` - 用户邮箱

#### 邮件设置
- **邮件主题**：自定义邮件主题模板（`%s` 会被替换为网站名称）
- **邮件内容**：自定义邮件内容模板
  - 第一个 `%s` = 用户名
  - 第二个 `%s` = 设置密码链接

#### 多语言支持
- **GTranslate**：自动翻译邮件内容到用户语言
- **WPML**：支持手动翻译邮件模板
- **TranslatePress**：支持可视化翻译邮件内容
- 邮件会根据用户的语言偏好自动发送对应语言版本

### 工作流程
1. 游客用户在网站下单
2. 系统检查邮箱是否已注册
3. 如未注册且启用了自动注册功能：
   - 自动创建用户账户
   - 生成密码重置密钥
   - 发送包含设置密码链接的邮件
   - 在订单中记录操作日志

### 示例配置

**邮件主题**：
```
[%s] 欢迎！请设置您的账户密码
```

**邮件内容**：
```
亲爱的客户，

感谢您的订单！我们已为您创建了账户：

用户名：%s
设置密码：%s

请点击上方链接设置您的密码以完成账户激活。

如有疑问，请联系客服。
```

**自定义密码链接示例**：
```
https://yourdomain.com/my-account/set-password?key=%key%&user=%login%&email=%email%
```

## 安装和使用
1. 将插件文件上传到 `/wp-content/plugins/NP-time/` 目录
2. 在WordPress后台激活插件
3. 进入 "NP-Time" 菜单进行配置

## 兼容性
- WordPress 5.6+
- PHP 7.4+
- WooCommerce 3.0+

## 更新日志

### v1.1.0
- ✨ 新增：用户注册设置功能
- ✨ 新增：下单后自动为未注册邮箱创建账户
- ✨ 新增：默认使用WooCommerce我的账户页面作为密码重置链接
- ✨ 新增：可自定义设置密码链接，支持占位符
- ✨ 新增：可配置注册邮件主题和内容
- ✨ 新增：完整的多语言支持（GTranslate、WPML、TranslatePress）
- 🔧 改进：邮件发送结果会记录到订单备注
- 🔧 改进：支持关闭自动注册功能
- 🔧 改进：智能链接回退机制，确保兼容性
